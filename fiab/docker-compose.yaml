version: '3'
services:

  database:
    image: 'mongo'
    container_name: 'fledge-db'
    volumes:
      - ./mongodata:/data/db
    ports:
      - '27017-27019:27017-27019'

  notifier:
    image: 'fledge'
    container_name: 'fledge-notifier'
    command: /usr/bin/notifier
    ports:
      - '10101:10101'
    build:
      context: ../
      dockerfile: ./build/Dockerfile.dev

  controller:
    image: 'fledge'
    container_name: 'fledge-controller'
    # The ""sleep 5"" is to mitigate failure to connect mongodb
    # if controler comes up before mongodb
    # TODO: refactor controller code to retry connection in case of disconnection
    command: >
      bash -c "sleep 5 &&
      /usr/bin/controller
      --db mongodb://fledge-db:27017
      --notifier fledge-notifier:10101
      --platform docker"
    ports:
      - '10102:10102'
    depends_on: ['database', 'notifier']

  apiserver:
    image: 'fledge'
    container_name: 'fledge-apiserver'
    command: /usr/bin/apiserver --controller fledge-controller:10102
    ports:
      - '10100:10100'
    depends_on: ['controller']

  fledgelet1:
    image: 'fledge'
    container_name: 'fledgelet1'
    # NOTE: update FLEDGE_AGENT_ID based on the payload
    # to use in the t_payload collection in the DB
    environment:
      FLEDGE_AGENT_ID: f7973f5a9f16b722545d84b704e5f8be4f773a3b
    command: /usr/bin/fledgelet --apiserver fledge-apiserver:10100 --notifier fledge-notifier:10101
    ports:
      - '10103:10103'
    depends_on: ['apiserver', 'notifier']

  fledgelet2:
    image: 'fledge'
    container_name: 'fledgelet2'
    # NOTE: update FLEDGE_AGENT_ID based on the payload
    # to use in the t_payload collection in the DB
    environment:
      FLEDGE_AGENT_ID: 505f9fc483cf4df68a2409257b5fad7d3c580370
    command: /usr/bin/fledgelet --apiserver fledge-apiserver:10100 --notifier fledge-notifier:10101
    ports:
      - '10104:10104'
    depends_on: ['apiserver', 'notifier']

  fledgelet3:
    image: 'fledge'
    container_name: 'fledgelet3'
    # NOTE: update FLEDGE_AGENT_ID based on the payload
    # to use in the t_payload collection in the DB
    environment:
      FLEDGE_AGENT_ID: 49d06b7526964db86cf37c70e8e0cdb6bd7aa742
    command: /usr/bin/fledgelet --apiserver fledge-apiserver:10100 --notifier fledge-notifier:10101
    ports:
      - '10105:10105'
    depends_on: ['apiserver', 'notifier']
